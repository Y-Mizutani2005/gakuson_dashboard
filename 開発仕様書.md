## **Google Analytics アクティブユーザー数可視化アプリ 開発要件定義書**

### **1\. プロジェクト概要**

本プロジェクトは、Google Analytics Data API v1 を利用して、指定したWebサイトの特定期間におけるアクティブユーザー数を取得し、その推移を可視化するWebアプリケーションを開発することを目的とします。

ユーザーはWebアプリ上で直感的に期間を指定し、グラフでアクティブユーザー数の変動を把握できるようになります。

### **2\. 開発環境・利用技術**

| カテゴリ | 技術・ツール | 役割 |
| :---- | :---- | :---- |
| **開発支援** | GeminiCLI | コード実装、ドキュメントに基づいた開発全般 |
| **フロントエンド** | Python / Streamlit | ユーザーインターフェースの構築、データの可視化 |
| **バックエンド** | FastAPI | フロントエンドからのリクエスト受付、Google Analytics Data APIとの連携 |
| **Google API** | Google Analytics Data API v1 | アクティブユーザー数のデータソース |

### **3\. アプリケーションアーキテクチャ**

本アプリケーションは、フロントエンド（Streamlit）とバックエンド（FastAPI）を分離した構成を取ります。

graph TD  
    A\[ユーザー\] \--\>|1. 期間を選択し表示ボタンを押す| B(フロントエンド: Streamlit);  
    B \--\>|2. APIリクエスト\<br\>(期間情報)| C(バックエンド: FastAPI);  
    C \--\>|3. サービスアカウント認証\<br\>Data APIリクエスト| D(Google Analytics Data API);  
    D \--\>|4. アクティブユーザー数データ返却| C;  
    C \--\>|5. データをJSON形式で返却| B;  
    B \--\>|6. 受け取ったデータをグラフ化して表示| A;

**処理フロー:**

1. ユーザーがStreamlitで構築されたWeb画面にアクセスし、アクティブユーザー数を表示したい期間を選択します。  
2. Streamlitは、指定された期間情報を付与して、FastAPIで構築されたバックエンドのAPIエンドポイントにリクエストを送信します。  
3. FastAPIはリクエストを受け取り、事前に設定されたGoogleサービスアカウントの認証情報を用いて、Google Analytics Data APIにアクティブユーザー数のデータをリクエストします。  
4. FastAPIはData APIから取得したデータを整形・加工し、JSON形式でStreamlitに返却します。  
5. Streamlitは受け取ったJSONデータを元に、グラフを描画してユーザーに提示します。

### **4\. 機能要件**

#### **4.1. データ取得・バックエンド (FastAPI)**

| No. | 機能 | 詳細 |
| :---- | :---- | :---- |
| **F-001** | **Google API 認証** | サービスアカウントキー（JSONファイル）を用いてGoogle Analytics Data APIへの認証を行う。キーファイルのパスは環境変数などで管理し、コードに直接埋め込まないこと。 |
| **F-002** | **GAプロパティ指定** | データを取得するGoogle AnalyticsのプロパティIDを指定できること。これも環境変数での管理を推奨。 |
| **F-003** | **アクティブユーザー数取得** | 指定された期間（開始日・終了日）の日別アクティブユーザー数を取得する。利用する指標は activeUsers とする。 |
| **F-004** | **APIエンドポイント** | フロントエンドからのリクエストを受け付けるためのAPIエンドポイントを1つ用意する。(詳細は「5. APIエンドポイント設計」を参照) |

#### **4.2. データ表示・フロントエンド (Streamlit)**

| No. | 機能 | 詳細 |
| :---- | :---- | :---- |
| **F-005** | **期間指定UI** | ユーザーがデータ取得期間の開始日と終了日をカレンダー形式で選択できること。(例: st.date\_input) |
| **F-006** | **データ取得実行** | ユーザーが「表示」ボタンなどを押すことで、バックエンドへのデータ取得リクエストが実行されること。 |
| **F-007** | **グラフ表示** | 取得した日別アクティブユーザー数の推移を折れ線グラフで表示すること。(例: st.line\_chart) グラフにはタイトルや軸ラベルを適切に表示する。 |
| **F-008** | **数値表示** | グラフと合わせて、指定期間の合計アクティブユーザー数、または平均アクティブユーザー数を数値で表示すること。(例: st.metric) |
| **F-009** | **ローディング表示** | データ取得中は、ユーザーに処理中であることが分かるようなインジケーター（スピナーなど）を表示すること。(例: st.spinner) |
| **F-010** | **エラー表示** | データ取得に失敗した場合（APIエラーなど）、ユーザーにエラーが発生した旨を分かりやすく通知すること。 |

### **5\. APIエンドポイント設計 (FastAPI)**

バックエンドは以下のAPIエンドポイントを提供します。

* **エンドポイント:** GET /api/v1/active-users  
* **説明:** 指定された期間の日別アクティブユーザー数を返却する。  
* **クエリパラメータ:**  
  * start\_date (string, required): 開始日 (形式: YYYY-MM-DD)  
  * end\_date (string, required): 終了日 (形式: YYYY-MM-DD)  
* **成功レスポンス (200 OK):**  
  {  
    "start\_date": "2025-06-01",  
    "end\_date": "2025-06-07",  
    "property\_id": "123456789",  
    "data": \[  
      {"date": "2025-06-01", "active\_users": 150},  
      {"date": "2025-06-02", "active\_users": 165},  
      {"date": "2025-06-03", "active\_users": 143},  
      {"date": "2025-06-04", "active\_users": 180},  
      {"date": "2025-06-05", "active\_users": 210},  
      {"date": "2025-06-06", "active\_users": 198},  
      {"date": "2025-06-07", "active\_users": 176}  
    \]  
  }

* **エラーレスポンス (4xx, 5xx):**  
  {  
    "detail": "Error message describing the issue."  
  }

### **6\. 非機能要件**

| 項目 | 内容 |
| :---- | :---- |
| **セキュリティ** | Google APIの認証情報（サービスアカウントキー）は、リポジトリに含めず、環境変数やデプロイ環境のシークレット管理機能を利用して安全に管理すること。 |
| **ユーザビリティ** | 専門知識がないユーザーでも直感的に操作できるシンプルなUIを心がける。 |
| **保守性** | 設定値（GAプロパティIDなど）はコードから分離し、設定ファイルや環境変数で管理することで、変更を容易にする。 |

### **7\. 開発ステップの提案**

GeminiCLIは以下のステップで開発を進めることを推奨します。

1. **環境構築:**  
   * Python環境のセットアップ。  
   * streamlit, fastapi, uvicorn, google-analytics-data ライブラリのインストール。  
2. **Google API準備:**  
   * Google Cloud Platformでプロジェクトを作成。  
   * Google Analytics Data API v1を有効化。  
   * サービスアカウントを作成し、キー（JSONファイル）をダウンロード。  
   * Google Analytics側で、作成したサービスアカウントのメールアドレスに閲覧権限を付与。  
3. **バックエンド実装 (FastAPI):**  
   * まず、Google APIに接続し、固定の期間でデータを取得するコアロジックを実装・テストする。  
   * 次に、5. APIエンドポイント設計 に基づいてFastAPIのルーティングを実装する。  
4. **フロントエンド実装 (Streamlit):**  
   * 4.2. データ表示・フロントエンド に基づき、UIコンポーネントを配置する。  
   * 「表示」ボタンが押されたら、FastAPIのAPIを呼び出し、レスポンスをグラフに描画する処理を実装する。  
5. **結合と仕上げ:**  
   * フロントエンドとバックエンドを連携させ、全体の動作を確認する。  
   * エラーハンドリングやローディング表示を実装し、UXを向上させる。

### **8\. テスト事項**

| テスト種別 | 確認項目 |
| :---- | :---- |
| 単体テスト (バックエンド) | ・正常な期間指定で、Data APIから意図した形式のデータが返却されるか。 ・開始日と終了日が逆転しているなど、不正なリクエストに対して適切なエラーが返るか。 ・Google API認証情報が無効な場合に、エラーハンドリングが正しく機能するか。 |
| 単体テスト (フロントエンド) | ・日付ピッカーで選択した日付が、バックエンドへのリクエストに正しく反映されるか。 ・バックエンドから受け取ったJSONデータで、グラフが正しく描画されるか。 ・バックエンドからエラーが返却された場合に、エラーメッセージが表示されるか。 |
| **結合テスト** | ・フロントエンドで期間を指定してボタンを押すと、意図した期間のアクティブユーザー数がグラフ表示されるか（E2Eシナリオ）。 ・データ取得中にローディング表示がなされるか。 |

### **9\. 重要事項・自発的提案**

* **エラーハンドリングの具体化:**  
  * Google APIからのエラー（権限不足、クォータ超過など）と、FastAPI自体のエラーを区別し、フロントエンドで分かりやすいメッセージを表示できるように、バックエンドのエラーレスポンスに error\_code のようなフィールドを追加することを推奨します。  
* **キャッシュの実装によるパフォーマンス向上:**  
  * FastAPIまたはStreamlitのキャッシュ機能（例: st.cache\_data）を利用し、同じ期間のリクエストが短時間で繰り返された場合に、都度APIを呼び出すのではなくキャッシュしたデータを返すことで、Google APIへのリクエスト回数を節約し、表示速度を向上させることができます。  
* **将来的な拡張性の考慮:**  
  * 今回は「アクティブユーザー数」のみですが、将来的に「新規ユーザー数」「セッション数」「コンバージョン数」など、他の指標も追加できるように、バックエンドのデータ取得ロジックを汎用的に設計しておくことを推奨します。例えば、APIのエンドポイントで取得したい指標（metrics）を指定できるようにするなどの工夫が考えられます。